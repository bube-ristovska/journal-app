{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –ù–∞–≤–∏–∫–∏ - –ú–µ–Ω—Ç–∞–ª–Ω–æ–ó–¥—Ä–∞–≤—ò–µ{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="text-center">
        <h1 class="text-4xl font-bold text-purple-800 mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –ù–∞–≤–∏–∫–∏</h1>
        <p class="text-purple-600 text-lg">
            –ê–Ω–∞–ª–∏–∑–∞ –Ω–∞ —Ç–≤–æ—ò–æ—Ç –ø—Ä–æ–≥—Ä–µ—Å –≤–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 30 –¥–µ–Ω–∞
        </p>
    </div>

    <!-- Overall Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        {% set total_habits = analytics_data|length %}
        {% set total_completed = analytics_data.values()|sum(attribute='completed_days') %}
        {% set total_possible = total_habits * 30 %}
        {% set avg_completion = (total_completed / total_possible * 100) if total_possible > 0 else 0 %}
        {% set best_streak = analytics_data.values()|max(attribute='streak') if analytics_data else 0 %}

        <div class="card text-center">
            <div class="text-3xl mb-2">üéØ</div>
            <h3 class="text-lg font-semibold text-purple-800">–í–∫—É–ø–Ω–∏ –ù–∞–≤–∏–∫–∏</h3>
            <p class="text-2xl font-bold text-purple-600">{{ total_habits }}</p>
        </div>

        <div class="card text-center">
            <div class="text-3xl mb-2">‚úÖ</div>
            <h3 class="text-lg font-semibold text-purple-800">–ü—Ä–æ—Å–µ—á–µ–Ω –£—Å–ø–µ—Ö</h3>
            <p class="text-2xl font-bold text-green-600">{{ "%.1f"|format(avg_completion) }}%</p>
        </div>

        <div class="card text-center">
            <div class="text-3xl mb-2">üî•</div>
            <h3 class="text-lg font-semibold text-purple-800">–ù–∞—ò–¥–æ–ª–≥ –°—Ç—Ä–∏–∫</h3>
            <p class="text-2xl font-bold text-orange-600">{{ best_streak.streak if best_streak else 0 }} –¥–µ–Ω–∞</p>
        </div>

        <div class="card text-center">
            <div class="text-3xl mb-2">üìà</div>
            <h3 class="text-lg font-semibold text-purple-800">–í–∫—É–ø–Ω–æ –ó–∞–≤—Ä—à–µ–Ω–∏</h3>
            <p class="text-2xl font-bold text-blue-600">{{ total_completed }}</p>
        </div>
    </div>

    <!-- Completion Rate Chart -->
    <div class="card">
        <h2 class="text-2xl font-bold text-purple-800 mb-6">üìà –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –£—Å–ø–µ—à–Ω–æ—Å—Ç</h2>
        <div class="relative">
            <canvas id="completionChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Individual Habit Analytics -->
    <div class="card">
        <h2 class="text-2xl font-bold text-purple-800 mb-6">üîç –î–µ—Ç–∞–ª–Ω–∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –ù–∞–≤–∏–∫–∞</h2>

        <div class="space-y-6">
            {% for habit_id, data in analytics_data.items() %}
            <div class="bg-purple-50 border border-purple-200 rounded-xl p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">{{ data.habit.icon }}</span>
                        <div>
                            <h3 class="text-lg font-semibold text-purple-800">{{ data.habit.name }}</h3>
                            <p class="text-sm text-purple-600">{{ data.habit.category }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-purple-600">{{ "%.1f"|format(data.completion_rate) }}%</div>
                        <div class="text-sm text-purple-500">—É—Å–ø–µ—à–Ω–æ—Å—Ç</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-purple-600 mb-1">
                        <span>{{ data.completed_days }} –æ–¥ {{ data.total_days }} –¥–µ–Ω–∞</span>
                        <span>üî• {{ data.streak }} –¥–µ–Ω–∞ —Å—Ç—Ä–∏–∫</span>
                    </div>
                    <div class="w-full bg-purple-200 rounded-full h-3">
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-3 rounded-full transition-all duration-500"
                             style="width: {{ data.completion_rate }}%"></div>
                    </div>
                </div>

                <!-- Performance Indicator -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        {% if data.completion_rate >= 80 %}
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                üåü –û–¥–ª–∏—á–Ω–æ
                            </span>
                        {% elif data.completion_rate >= 60 %}
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                üëç –î–æ–±—Ä–æ
                            </span>
                        {% elif data.completion_rate >= 40 %}
                            <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                                ‚ö†Ô∏è –°—Ä–µ–¥–Ω–æ
                            </span>
                        {% else %}
                            <span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">
                                üí™ –ü–æ—Ç—Ä–µ–±–∞ –æ–¥ –ø–æ–¥–æ–±—Ä—É–≤–∞—ö–µ
                            </span>
                        {% endif %}
                    </div>

                    <!-- Streak Indicator -->
                    {% if data.streak > 0 %}
                    <div class="flex items-center space-x-1 text-orange-600">
                        <span class="text-sm font-medium">–ê–∫—Ç–∏–≤–µ–Ω —Å—Ç—Ä–∏–∫:</span>
                        <span class="font-bold">{{ data.streak }}</span>
                        <span class="text-lg">üî•</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Insights and Recommendations -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card">
            <h3 class="text-xl font-bold text-purple-800 mb-4">üéâ –¢–≤–æ–∏ –£—Å–ø–µ—Å–∏</h3>
            <div class="space-y-3">
                {% set best_habits = analytics_data.values()|sort(attribute='completion_rate', reverse=true)[:3] %}
                {% for habit_data in best_habits %}
                <div class="flex items-center space-x-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <span class="text-xl">{{ habit_data.habit.icon }}</span>
                    <div class="flex-1">
                        <p class="font-medium text-green-800">{{ habit_data.habit.name }}</p>
                        <p class="text-sm text-green-600">{{ "%.1f"|format(habit_data.completion_rate) }}% —É—Å–ø–µ—à–Ω–æ—Å—Ç</p>
                    </div>
                    <span class="text-2xl">üèÜ</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-bold text-purple-800 mb-4">üí™ –û–±–ª–∞—Å—Ç–∏ –∑–∞ –ü–æ–¥–æ–±—Ä—É–≤–∞—ö–µ</h3>
            <div class="space-y-3">
                {% set improvement_habits = analytics_data.values()|sort(attribute='completion_rate')[:3] %}
                {% for habit_data in improvement_habits %}
                <div class="flex items-center space-x-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <span class="text-xl">{{ habit_data.habit.icon }}</span>
                    <div class="flex-1">
                        <p class="font-medium text-orange-800">{{ habit_data.habit.name }}</p>
                        <p class="text-sm text-orange-600">{{ "%.1f"|format(habit_data.completion_rate) }}% —É—Å–ø–µ—à–Ω–æ—Å—Ç</p>
                    </div>
                    <span class="text-2xl">üìà</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-center space-x-4">
        <a href="{{ url_for('habits.index') }}" class="btn-primary">
            ‚úÖ –ù–∞–∑–∞–¥ –∫–æ–Ω –ù–∞–≤–∏–∫–∏
        </a>
        <button onclick="exportAnalytics()" class="btn-secondary">
            üìä –ò–∑–≤–µ–∑–∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        </button>
        <button onclick="printAnalytics()" class="btn-secondary">
            üñ®Ô∏è –ü–µ—á–∞—Ç–∏ –ò–∑–≤–µ—à—Ç–∞—ò
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    createCompletionChart();
});

function createCompletionChart() {
    const ctx = document.getElementById('completionChart').getContext('2d');

    const habits = [
        {% for habit_id, data in analytics_data.items() %}
        {
            name: "{{ data.habit.name }}",
            completion: {{ data.completion_rate }},
            completed: {{ data.completed_days }},
            total: {{ data.total_days }},
            category: "{{ data.habit.category }}"
        },
        {% endfor %}
    ];

    const categoryColors = {
        '–§–∏–∑–∏—á–∫–æ –∑–¥—Ä–∞–≤—ò–µ': '#ef4444',
        '–ú–µ–Ω—Ç–∞–ª–Ω–æ –∑–¥—Ä–∞–≤—ò–µ': '#8b5cf6',
        '–õ–∏—á–Ω–æ —Ä–∞–∑–≤–∏—Ç–∏–µ': '#06b6d4',
        '–°–æ—Ü–∏—ò–∞–ª–Ω–∏': '#10b981',
        '–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç': '#f59e0b',
        '–ë–ª–∞–≥–æ—Å–æ—Å—Ç–æ—ò–±–∞': '#84cc16',
        '–°–∞–º–æ–≥—Ä–∏–∂–∞': '#ec4899',
        '–î–∏–≥–∏—Ç–∞–ª–Ω–∞ –¥–µ—Ç–æ–∫—Å–∏–∫–∞—Ü–∏—ò–∞': '#6b7280',
        '–°–∞–º–æ—Ä–µfl–µ–∫—Å–∏—ò–∞': '#14b8a6',
        '–î–æ–±—Ä–æ–≤–æ–ª—Å—Ç–≤–æ': '#f97316',
        '–ü–æ–∑–∏—Ç–∏–≤–Ω–æ—Å—Ç': '#eab308'
    };

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: habits.map(h => h.name.length > 25 ? h.name.substring(0, 25) + '...' : h.name),
            datasets: [{
                label: '–ü—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –£—Å–ø–µ—à–Ω–æ—Å—Ç',
                data: habits.map(h => h.completion),
                backgroundColor: habits.map(h => categoryColors[h.category] || '#a855f7'),
                borderColor: habits.map(h => categoryColors[h.category] || '#7c3aed'),
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const habit = habits[context.dataIndex];
                            return [
                                `–£—Å–ø–µ—à–Ω–æ—Å—Ç: ${habit.completion.toFixed(1)}%`,
                                `–ó–∞–≤—Ä—à–µ–Ω–∏: ${habit.completed}/${habit.total} –¥–µ–Ω–∞`,
                                `–ö–∞—Ç–µ–≥–æ—Ä–∏—ò–∞: ${habit.category}`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: '#e5e7eb'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

function exportAnalytics() {
    const analyticsData = {
        exportDate: new Date().toLocaleDateString('mk-MK'),
        period: '–ü–æ—Å–ª–µ–¥–Ω–∏ 30 –¥–µ–Ω–∞',
        summary: {
            totalHabits: {{ analytics_data|length }},
            averageCompletion: {{ "%.1f"|format(avg_completion) }},
            bestStreak: {{ best_streak.streak if best_streak else 0 }},
            totalCompleted: {{ total_completed }}
        },
        habits: [
            {% for habit_id, data in analytics_data.items() %}
            {
                name: "{{ data.habit.name }}",
                category: "{{ data.habit.category }}",
                completionRate: {{ data.completion_rate }},
                completedDays: {{ data.completed_days }},
                totalDays: {{ data.total_days }},
                currentStreak: {{ data.streak }}
            },
            {% endfor %}
        ]
    };

    const dataStr = JSON.stringify(analyticsData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏-–Ω–∞–≤–∏–∫–∏-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);

    showNotification('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏—Ç–µ —Å–µ –∏–∑–≤–µ–∑–µ–Ω–∏! üìä', 'success');
}

function printAnalytics() {
    window.print();
}
</script>

<style>
@media print {
    .btn-primary, .btn-secondary, nav, footer {
        display: none !important;
    }

    .card {
        page-break-inside: avoid;
        margin-bottom: 20px;
    }

    body {
        background: white !important;
    }
}
</style>
{% endblock %}