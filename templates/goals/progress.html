{% extends "base.html" %}

{% block title %}–¶–µ–ª–∏ - –ú–µ–Ω—Ç–∞–ª–Ω–æ–ó–¥—Ä–∞–≤—ò–µ{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-purple-800 mb-2">üéØ –ú–æ–∏ –¶–µ–ª–∏</h1>
            <p class="text-purple-600">–°–ª–µ–¥–∏ –≥–æ —Ç–≤–æ—ò–æ—Ç –ø—Ä–æ–≥—Ä–µ—Å –∏ –æ—Å—Ç–≤–∞—Ä–∏ –≥–∏ —Ç–≤–æ–∏—Ç–µ —Å–æ–Ω–∏—à—Ç–∞</p>
        </div>
        <a href="{{ url_for('goals.set_goal') }}" class="btn-primary">
            ‚ûï –ü–æ—Å—Ç–∞–≤–∏ –Ω–æ–≤–∞ —Ü–µ–ª
        </a>
    </div>
</div>

{% if goals %}
<div class="space-y-6">
    {% for goal in goals %}
    <div class="card hover:shadow-2xl transition-all duration-300">
        <!-- Goal Header -->
        <div class="flex justify-between items-start mb-4">
            <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                    <h3 class="text-xl font-bold text-purple-800">{{ goal.title }}</h3>
                    <span class="px-3 py-1 text-xs font-semibold rounded-full
                        {% if goal.priority == 'high' %}bg-red-100 text-red-800
                        {% elif goal.priority == 'medium' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
                        {% if goal.priority == 'high' %}–í–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        {% elif goal.priority == 'medium' %}–°—Ä–µ–¥–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        {% else %}–ù–∏–∑–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç{% endif %}
                    </span>
                </div>

                {% if goal.description %}
                <p class="text-gray-700 mb-3">{{ goal.description }}</p>
                {% endif %}

                <div class="flex items-center space-x-4 text-sm text-purple-600">
                    <span class="bg-purple-100 px-2 py-1 rounded-lg">{{ goal.category }}</span>
                    {% if goal.target_date %}
                    <span class="flex items-center space-x-1">
                        <span>üìÖ</span>
                        <span>{{ goal.target_date.strftime('%d.%m.%Y') }}</span>
                    </span>
                    {% endif %}
                    {% if goal.target_date %}
                    {% set days_left = (goal.target_date - today).days %}
                    <span class="{% if days_left < 0 %}text-red-600{% elif days_left < 7 %}text-orange-600{% else %}text-green-600{% endif %}">
                        {% if days_left < 0 %}
                        üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ωo {{ -days_left }} –¥–µ–Ω{% if -days_left != 1 %}–æ–≤–∏{% endif %}
                        {% elif days_left == 0 %}
                        üü° –î–µ–Ω–µ—Å –µ –∫—Ä–∞—ò–Ω–∏–æ—Ç —Ä–æ–∫!
                        {% else %}
                        üü¢ –£—à—Ç–µ {{ days_left }} –¥–µ–Ω{% if days_left != 1 %}–æ–≤–∏{% endif %}
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-purple-700">–ü—Ä–æ–≥—Ä–µ—Å</span>
                <span class="text-sm font-bold text-purple-800">{{ goal.progress }}%</span>
            </div>
            <div class="w-full bg-purple-200 rounded-full h-3">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-300"
                     style="width: {{ goal.progress }}%"></div>
            </div>
        </div>

        <!-- Manual Progress Update -->
        <div class="mb-4 flex items-center space-x-3">
            <label class="text-sm font-medium text-purple-700">–ê–∂—É—Ä–∏—Ä–∞—ò –ø—Ä–æ–≥—Ä–µ—Å:</label>
            <input type="range"
                   class="flex-1 h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer"
                   min="0" max="100"
                   value="{{ goal.progress }}"
                   onchange="updateProgress({{ goal.id }}, this.value)">
            <span id="progress-display-{{ goal.id }}" class="text-sm font-bold text-purple-800 w-12">{{ goal.progress }}%</span>
        </div>

        <!-- Milestones -->
        {% if goal.milestones %}
        <div class="mb-4">
            <h4 class="font-semibold text-purple-800 mb-3">üóìÔ∏è –ú–µ—Ä–Ω–∏ –∫–∞–º–µ—ö–∞</h4>
            <div class="space-y-2">
                {% for milestone in goal.milestones %}
                <div class="flex items-center space-x-3 p-3 rounded-lg
                    {% if milestone.completed %}bg-green-50 border border-green-200
                    {% else %}bg-gray-50 border border-gray-200{% endif %}">

                    <input type="checkbox"
                           class="w-5 h-5 text-purple-600 rounded"
                           {% if milestone.completed %}checked{% endif %}
                           onchange="toggleMilestone({{ milestone.id }}, this.checked)">

                    <div class="flex-1">
                        <p class="font-medium {% if milestone.completed %}text-green-800 line-through{% else %}text-gray-800{% endif %}">
                            {{ milestone.title }}
                        </p>
                        {% if milestone.description %}
                        <p class="text-sm {% if milestone.completed %}text-green-600{% else %}text-gray-600{% endif %}">
                            {{ milestone.description }}
                        </p>
                        {% endif %}
                        {% if milestone.due_date %}
                        <p class="text-xs {% if milestone.completed %}text-green-500{% else %}text-gray-500{% endif %}">
                            üìÖ {{ milestone.due_date.strftime('%d.%m.%Y') }}
                        </p>
                        {% endif %}
                    </div>

                    {% if milestone.completed %}
                    <div class="text-green-600">
                        <span class="text-lg">‚úÖ</span>
                        {% if milestone.completed_date %}
                        <p class="text-xs">{{ milestone.completed_date.strftime('%d.%m') }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Goal Status -->
        <div class="flex justify-between items-center pt-4 border-t border-purple-100">
            <div class="flex items-center space-x-2">
                {% if goal.progress >= 100 %}
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    üéâ –ó–∞–≤—Ä—à–µ–Ω–æ!
                </span>
                {% elif goal.progress >= 75 %}
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                    üöÄ –†–µ—á–∏—Å–∏ –≥–æ—Ç–æ–≤–æ
                </span>
                {% elif goal.progress >= 50 %}
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                    ‚ö° –í–æ –ø—Ä–æ–≥—Ä–µ—Å
                </span>
                {% elif goal.progress >= 25 %}
                <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                    üîÑ –ó–∞–ø–æ—á–Ω–∞—Ç–æ
                </span>
                {% else %}
                <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm font-medium">
                    üìã –ü–ª–∞–Ω–∏—Ä–∞–Ω–æ
                </span>
                {% endif %}
            </div>

            <div class="text-xs text-gray-500">
                –ö—Ä–µ–∏—Ä–∞–Ω–æ: {{ goal.created_at.strftime('%d.%m.%Y') }}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Goal Statistics -->
<div class="mt-12 grid md:grid-cols-3 gap-6">
    <div class="card text-center">
        <div class="text-4xl mb-3">üéØ</div>
        <h3 class="text-lg font-bold text-purple-800 mb-2">–ê–∫—Ç–∏–≤–Ω–∏ —Ü–µ–ª–∏</h3>
        <p class="text-3xl font-bold text-purple-600">{{ goals|length }}</p>
    </div>

    <div class="card text-center">
        <div class="text-4xl mb-3">üìà</div>
        <h3 class="text-lg font-bold text-purple-800 mb-2">–ü—Ä–æ—Å–µ—á–µ–Ω –ø—Ä–æ–≥—Ä–µ—Å</h3>
        {% set avg_progress = (goals|sum(attribute='progress') / goals|length) if goals else 0 %}
        <p class="text-3xl font-bold text-purple-600">{{ "%.0f"|format(avg_progress) }}%</p>
    </div>

    <div class="card text-center">
        <div class="text-4xl mb-3">‚úÖ</div>
        <h3 class="text-lg font-bold text-purple-800 mb-2">–ó–∞–≤—Ä—à–µ–Ω–∏ —Ü–µ–ª–∏</h3>
        {% set completed_goals = goals|selectattr('progress', 'ge', 100)|list|length %}
        <p class="text-3xl font-bold text-purple-600">{{ completed_goals }}</p>
    </div>
</div>

{% else %}
<!-- Empty State -->
<div class="card text-center py-16">
    <div class="text-8xl mb-6">üéØ</div>
    <h2 class="text-2xl font-bold text-purple-800 mb-4">–ó–∞–ø–æ—á–Ω–∏ —Å–æ —Ç–≤–æ–∏—Ç–µ —Ü–µ–ª–∏!</h2>
    <p class="text-purple-600 mb-8 max-w-md mx-auto">
        –ü–æ—Å—Ç–∞–≤—É–≤–∞—ö–µ—Ç–æ —Ü–µ–ª–∏ –µ –ø—Ä–≤–∏–æ—Ç —á–µ–∫–æ—Ä –∫–æ–Ω –æ—Å—Ç–≤–∞—Ä—É–≤–∞—ö–µ –Ω–∞ —Ç–≤–æ–∏—Ç–µ —Å–æ–Ω–∏—à—Ç–∞.
        –ó–∞–ø–æ—á–Ω–∏ –¥–µ–Ω–µ—Å –∏ –∏–∑–≥—Ä–∞–¥–∏ –≥–æ –∂–∏–≤–æ—Ç–æ—Ç —à—Ç–æ –≥–æ —Å–∞–∫–∞—à.
    </p>
    <a href="{{ url_for('goals.set_goal') }}" class="btn-primary">
        üöÄ –ü–æ—Å—Ç–∞–≤–∏ —Ç–≤–æ—ò–∞ –ø—Ä–≤–∞ —Ü–µ–ª
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
async function updateProgress(goalId, progress) {
    document.getElementById(`progress-display-${goalId}`).textContent = progress + '%';

    try {
        const response = await fetch('/goals/update_progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                goal_id: goalId,
                progress: parseInt(progress)
            })
        });

        const result = await response.json();
        if (result.success) {
            showNotification('–ü—Ä–æ–≥—Ä–µ—Å–æ—Ç –µ –∞–∂—É—Ä–∏—Ä–∞–Ω!', 'success');
            if (parseInt(progress) >= 100) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–∂—É—Ä–∏—Ä–∞—ö–µ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å–æ—Ç', 'error');
        }
    } catch (error) {
        showNotification('–ì—Ä–µ—à–∫–∞ –≤–æ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞—Ç–∞', 'error');
    }
}

async function toggleMilestone(milestoneId, completed) {
    try {
        const response = await fetch('/goals/complete_milestone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                milestone_id: milestoneId
            })
        });

        const result = await response.json();
        if (result.success) {
            showNotification('–ú–µ—Ä–Ω–∏–æ—Ç –∫–∞–º–µ–Ω –µ –∞–∂—É—Ä–∏—Ä–∞–Ω!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–∂—É—Ä–∏—Ä–∞—ö–µ', 'error');
        }
    } catch (error) {
        showNotification('–ì—Ä–µ—à–∫–∞ –≤–æ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞—Ç–∞', 'error');
    }
}
</script>
{% endblock %}